<!-- templates/wizard/wizard_main.html -->
{% extends "wizard/wizard_base.html" %}

{% block step_content %}
  {% include "wizard/step_1_course_selection.html" %}
  {% include "wizard/step_2_group_set_selection.html" %}
  {% include "wizard/step_3_group_selection.html" %}
  {% include "wizard/step_4_integration_config.html" %}
  {% include "wizard/step_5_confirmation.html" %}
  {% include "wizard/step_6_results.html" %}
  
  <script>
    // Create a global wizardContext object to store data from Django
    window.wizardContext = {
      current_step: {{ current_step }},
      wizard_data: {% if wizard_data %}{{ wizard_data|safe|default:'{}' }}{% else %}{}{% endif %},
      debug_mode: {{ debug|default:"false" }}
    };
    
    // Add course data
    {% if step_data.courses_json %}
    try {
      window.wizardContext.courses = JSON.parse('{{ step_data.courses_json|escapejs }}');
    } catch (e) {
      window.wizardContext.courses = [];
    }
    {% else %}
    window.wizardContext.courses = [];
    {% endif %}
    
    // Add group sets data
    {% if step_data.group_sets_json %}
    try {
      window.wizardContext.group_sets = JSON.parse('{{ step_data.group_sets_json|escapejs }}');
    } catch (e) {
      window.wizardContext.group_sets = [];
    }
    {% else %}
    window.wizardContext.group_sets = [];
    {% endif %}
    
    // Add groups data
    {% if step_data.groups_json %}
    try {
      window.wizardContext.groups = JSON.parse('{{ step_data.groups_json|escapejs }}');
    } catch (e) {
      window.wizardContext.groups = [];
    }
    {% else %}
    window.wizardContext.groups = [];
    {% endif %}
    
    // Add created teams data
    {% if step_data.created_teams_json %}
    try {
      window.wizardContext.created_teams = JSON.parse('{{ step_data.created_teams_json|escapejs }}');
    } catch (e) {
      window.wizardContext.created_teams = [];
    }
    {% else %}
    window.wizardContext.created_teams = [];
    {% endif %}
    
    document.addEventListener('DOMContentLoaded', function() {
      // Make sure the first step is shown initially when the page loads
      var currentStep = {{ current_step }};
      
      // If coming to the page fresh, always start at step 1
      if (window.location.search === '') {
        currentStep = 1;
      }
      
      var currentStepSelector = '#step' + currentStep;
      var currentTabPane = document.querySelector(currentStepSelector);
      
      // Make sure the tab content is visible
      if (currentTabPane) {
        // Use vanilla JS if jQuery isn't available
        if (typeof $ === 'undefined') {
          document.querySelectorAll('.tab-pane').forEach(function(pane) {
            pane.classList.remove('show', 'active');
          });
          currentTabPane.classList.add('show', 'active');
          
          // Handle tab navigation with vanilla JS
          document.querySelectorAll('.nav-pills .nav-link').forEach(function(link) {
            link.classList.remove('active');
          });
          var navLinks = document.querySelectorAll('.nav-pills .nav-link');
          if (navLinks.length > currentStep - 1) {
            navLinks[currentStep - 1].classList.add('active');
          }
        } else {
          // Use jQuery if available
          $('.tab-pane').removeClass('show active');
          currentTabPane.classList.add('show', 'active');
          
          // Make sure the tab navigation is correct
          $('.nav-pills .nav-link').removeClass('active');
          $('.nav-pills .nav-link').eq(currentStep - 1).addClass('active');
        }
      }
    });
  </script>
{% endblock %}
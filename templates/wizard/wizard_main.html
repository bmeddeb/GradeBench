<!-- templates/wizard/wizard_main.html -->
{% extends "wizard/wizard_base.html" %}

{% block step_content %}
  {% include "wizard/step_1_course_selection.html" %}
  {% include "wizard/step_2_group_set_selection.html" %}
  {% include "wizard/step_3_group_selection.html" %}
  {% include "wizard/step_4_integration_config.html" %}
  {% include "wizard/step_5_confirmation.html" %}
  {% include "wizard/step_6_results.html" %}
  
  <script>
    console.log("Initializing wizardContext");
    
    // Create a global wizardContext object to store data from Django
    window.wizardContext = {
      current_step: {{ current_step }},
      
      // Add debug info - make sure we convert Python objects to JSON
      wizard_data: {% if wizard_data %}{{ wizard_data|safe|default:'{}' }}{% else %}{}{% endif %},
      
      // Flag for debugging
      debug_mode: {% if debug %}true{% else %}false{% endif %}
    };
    
    // Add course data
    {% if step_data.courses %}
    try {
      window.wizardContext.courses = JSON.parse('{{ step_data.courses|escapejs }}');
      console.log("Loaded courses:", window.wizardContext.courses.length);
    } catch (e) {
      console.error("Error parsing courses JSON:", e);
      window.wizardContext.courses = [];
    }
    {% else %}
    window.wizardContext.courses = [];
    {% endif %}
    
    // Add group sets data
    {% if step_data.group_sets %}
    try {
      window.wizardContext.group_sets = JSON.parse('{{ step_data.group_sets|escapejs }}');
      console.log("Loaded group sets:", window.wizardContext.group_sets.length);
    } catch (e) {
      console.error("Error parsing group sets JSON:", e);
      window.wizardContext.group_sets = [];
    }
    {% else %}
    window.wizardContext.group_sets = [];
    {% endif %}
    
    // Add groups data
    {% if step_data.groups %}
    try {
      window.wizardContext.groups = JSON.parse('{{ step_data.groups|escapejs }}');
      console.log("Loaded groups:", window.wizardContext.groups.length);
    } catch (e) {
      console.error("Error parsing groups JSON:", e);
      window.wizardContext.groups = [];
    }
    {% else %}
    window.wizardContext.groups = [];
    {% endif %}
    
    // Add created teams data
    {% if step_data.created_teams %}
    try {
      window.wizardContext.created_teams = JSON.parse('{{ step_data.created_teams|escapejs }}');
      console.log("Loaded created teams:", window.wizardContext.created_teams.length);
    } catch (e) {
      console.error("Error parsing created teams:", e);
      window.wizardContext.created_teams = [];
    }
    {% else %}
    window.wizardContext.created_teams = [];
    {% endif %}
    
    document.addEventListener('DOMContentLoaded', function() {
      // Make sure the first step is shown initially when the page loads
      var currentStep = {{ current_step }};
      
      // If coming to the page fresh, always start at step 1
      if (window.location.search === '') {
        currentStep = 1;
      }
      
      var currentStepSelector = '#step' + currentStep;
      var currentTabPane = document.querySelector(currentStepSelector);
      
      // Make sure the tab content is visible
      if (currentTabPane) {
        $('.tab-pane').removeClass('show active');
        currentTabPane.classList.add('show', 'active');
      }
      
      // Make sure the tab navigation is correct
      $('.nav-pills .nav-link').removeClass('active');
      $('.nav-pills .nav-link').eq(currentStep - 1).addClass('active');
    });
  </script>
{% endblock %}
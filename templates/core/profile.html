{% extends 'base.html' %}
{% load user_timezone %}

{% block title %}Profile - GradeBench{% endblock %}
{% block page_title %}User Profile{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card card-user">
            <div class="image">
                <img src="/static/img/bg/damir-bosnjak.jpg" alt="Background Image">
            </div>
            <div class="card-body">
                <div class="author">
                    <a href="#">
                        {% if profile.github_avatar_url %}
                            <img class="avatar border-gray" src="{{ profile.github_avatar_url }}" alt="{{ user.username }}'s GitHub avatar">
                        {% else %}
                            <img class="avatar border-gray" src="/static/img/default-avatar.png" alt="Default avatar">
                        {% endif %}
                        <h5 class="title">{{ user.get_full_name|default:user.username }}</h5>
                    </a>
                    <p class="description">
                        @{{ user.username }}
                    </p>
                </div>
                <p class="description text-center">
                    {% if profile.github_username %}
                    GitHub: {{ profile.github_username }}<br>
                    {% endif %}
                    Joined: {{ user.date_joined|user_timezone:user|date:"F j, Y" }}
                </p>
            </div>
            <div class="card-footer">
                <hr>
                <div class="button-container">
                    <div class="row">
                        <div class="col-lg-4 col-md-6 col-6 ml-auto">
                            <h5>5<br><small>Repos</small></h5>
                        </div>
                        <div class="col-lg-4 col-md-6 col-6 ml-auto mr-auto">
                            <h5>128<br><small>Commits</small></h5>
                        </div>
                        <div class="col-lg-4 mr-auto">
                            <h5>92.5%<br><small>Grade</small></h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title">Profile Information</h4>
            </div>
            <div class="card-body">
                <form id="profile-form" method="POST" action="{% url 'profile' %}">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 pr-1">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" class="form-control" name="username" value="{{ user.username }}">
                                <small class="form-text text-muted">Your username is your email by default</small>
                            </div>
                        </div>
                        <div class="col-md-6 pl-1">
                            <div class="form-group">
                                <label>Email address</label>
                                <input type="email" class="form-control" name="email" value="{{ user.email }}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 pr-1">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}">
                            </div>
                        </div>
                        <div class="col-md-6 pl-1">
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>GitHub Username</label>
                                <input type="text" class="form-control" disabled value="{{ profile.github_username|default:'' }}">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="text" class="form-control" name="phone_number" value="{{ profile.phone_number|default:'' }}">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Time Zone</label>
                                <select class="form-control" name="timezone">
                                    {% for tz in timezones %}
                                        <option value="{{ tz }}" {% if profile.timezone == tz %}selected{% endif %}>{{ tz }}</option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Select your local time zone for date and time display</small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="form-group">
                                <label>About Me</label>
                                <textarea class="form-control textarea" name="bio">{{ profile.bio|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="update ml-auto mr-auto">
                            <button type="submit" class="btn btn-primary btn-round">Update Profile</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // This is an alternative way to update the profile using our async API
    function updateProfileAsync() {
        const data = {
            username: document.querySelector('input[name="username"]').value,
            first_name: document.querySelector('input[name="first_name"]').value,
            last_name: document.querySelector('input[name="last_name"]').value,
            email: document.querySelector('input[name="email"]').value,
            phone_number: document.querySelector('input[name="phone_number"]').value,
            bio: document.querySelector('textarea[name="bio"]').value
        };

        // Send the update to our async API
        fetch('{% url "update_profile_async" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Create a success notification
                let alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.setAttribute('role', 'alert');
                
                // Add close button
                let closeButton = document.createElement('button');
                closeButton.className = 'close';
                closeButton.setAttribute('type', 'button');
                closeButton.setAttribute('data-bs-dismiss', 'alert');
                closeButton.setAttribute('aria-label', 'Close');
                closeButton.innerHTML = '<i class="nc-icon nc-simple-remove"></i>';
                
                // Add message
                let message = document.createElement('span');
                message.textContent = result.message || 'Profile updated successfully!';
                
                // Add elements to alert
                alertDiv.appendChild(closeButton);
                alertDiv.appendChild(message);
                
                // Add alert to page
                let messagesContainer = document.querySelector('.messages');
                if (!messagesContainer) {
                    messagesContainer = document.createElement('div');
                    messagesContainer.className = 'messages';
                    document.querySelector('.content').prepend(messagesContainer);
                }
                messagesContainer.appendChild(alertDiv);
                
                // Initialize the Bootstrap alert for dismissal
                new bootstrap.Alert(alertDiv);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    let alert = bootstrap.Alert.getInstance(alertDiv);
                    if (alert) {
                        alert.close();
                    } else {
                        alertDiv.remove();
                    }
                }, 5000);
            } else {
                // Show error message
                alert(result.message || 'Error updating profile.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating profile. Please try again.');
        });

        return false; // Prevent form submission
    }

    // You can use this instead of the form submission if you prefer the async approach
    document.querySelector('#profile-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Get the timezone from the form
        const timezoneSelect = document.querySelector('select[name="timezone"]');
        const timezone = timezoneSelect ? timezoneSelect.value : null;
        
        // Add timezone to the data to be sent
        const data = {
            username: document.querySelector('input[name="username"]').value,
            first_name: document.querySelector('input[name="first_name"]').value,
            last_name: document.querySelector('input[name="last_name"]').value,
            email: document.querySelector('input[name="email"]').value,
            phone_number: document.querySelector('input[name="phone_number"]').value,
            bio: document.querySelector('textarea[name="bio"]').value,
            timezone: timezone
        };
        
        // Send the update
        fetch('{% url "update_profile_async" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Create a success notification
                let alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.setAttribute('role', 'alert');
                
                // Add close button
                let closeButton = document.createElement('button');
                closeButton.className = 'close';
                closeButton.setAttribute('type', 'button');
                closeButton.setAttribute('data-bs-dismiss', 'alert');
                closeButton.setAttribute('aria-label', 'Close');
                closeButton.innerHTML = '<i class="nc-icon nc-simple-remove"></i>';
                
                // Add message
                let message = document.createElement('span');
                message.textContent = result.message || 'Profile updated successfully!';
                
                // Add elements to alert
                alertDiv.appendChild(closeButton);
                alertDiv.appendChild(message);
                
                // Add alert to page
                let messagesContainer = document.querySelector('.messages');
                if (!messagesContainer) {
                    messagesContainer = document.createElement('div');
                    messagesContainer.className = 'messages';
                    document.querySelector('.content').prepend(messagesContainer);
                }
                messagesContainer.appendChild(alertDiv);
                
                // Initialize the Bootstrap alert for dismissal
                new bootstrap.Alert(alertDiv);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    let alert = bootstrap.Alert.getInstance(alertDiv);
                    if (alert) {
                        alert.close();
                    } else {
                        alertDiv.remove();
                    }
                }, 5000);
            } else {
                // Show error message
                alert(result.message || 'Error updating profile.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating profile. Please try again.');
        });
    });
</script>
{% endblock %}
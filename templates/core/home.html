{% extends 'base.html' %}
{% load static %}
{% load user_timezone %}

{% block title %}Dashboard - GradeBench{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block nav_dashboard %}active{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'css/components/calendar.css' %}" />
<link rel="stylesheet" href="{% static 'css/components/clock.css' %}" />
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="card card-stats timezone-clock-card">
            <div class="card-body">
                <div class="row">
                    <div class="col-5 col-md-4">
                        <div class="icon-big text-center icon-warning">
                            <i class="nc-icon nc-calendar-60 text-info"></i>
                        </div>
                    </div>
                    <div class="col-7 col-md-8">
                        <div class="numbers">
                            <p class="card-category">Current Time</p>
                            <p id="user-timezone-clock" class="card-title">00:00</p>
                            <p id="user-timezone-date" class="timezone-date"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <hr>
                <div class="stats">
                    <i class="fa fa-clock-o"></i>
                    <span class="timezone-info">{{ user.profile.timezone }}</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col-5 col-md-4">
                        <div class="icon-big text-center icon-warning">
                            <i class="nc-icon nc-vector text-success"></i>
                        </div>
                    </div>
                    <div class="col-7 col-md-8">
                        <div class="numbers">
                            <p class="card-category">Commits</p>
                            <p class="card-title">128</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <hr>
                <div class="stats">
                    <i class="fa fa-calendar-o"></i> Last 7 days
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col-5 col-md-4">
                        <div class="icon-big text-center icon-warning">
                            <i class="nc-icon nc-favourite-28 text-primary"></i>
                        </div>
                    </div>
                    <div class="col-7 col-md-8">
                        <div class="numbers">
                            <p class="card-category">Grade</p>
                            <p class="card-title">92.5%</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <hr>
                <div class="stats">
                    <i class="fa fa-clock-o"></i> Current Average
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 col-sm-6">
        <div class="card card-stats">
            <div class="card-body">
                <div class="row">
                    <div class="col-5 col-md-4">
                        <div class="icon-big text-center icon-warning">
                            <i class="nc-icon nc-ruler-pencil text-danger"></i>
                        </div>
                    </div>
                    <div class="col-7 col-md-8">
                        <div class="numbers">
                            <p class="card-category">Assignments</p>
                            <p class="card-title">8</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <hr>
                <div class="stats">
                    <i class="fa fa-refresh"></i> Total Count
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calendar row -->
<div class="row">
    <div class="col-12">
        <div class="card card-calendar">
            <div class="card-header">
                <div class="row">
                    <div class="col-md-8">
                        <h4 class="card-title">Calendar</h4>
                        <p class="card-category">Your upcoming events and deadlines</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-sm btn-primary btn-round" data-bs-toggle="modal" data-bs-target="#importIcsModal">
                            <i class="fa fa-upload"></i> Import Calendar
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="calendar" class="fullcalendar-container"></div>
            </div>
            <div class="card-footer">
                <hr>
                <div class="stats">
                    <i class="fa fa-calendar"></i> Calendar is synchronized with your courses and assignments
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Import Calendar Modal -->
<div class="modal fade" id="importIcsModal" tabindex="-1" aria-labelledby="importIcsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importIcsModalLabel">Import Calendar (.ics file)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="uploadIcsForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="icsFile" class="form-label">Select a .ics calendar file</label>
                        <input class="form-control" type="file" id="icsFile" name="ics_file" accept=".ics">
                    </div>
                    <div class="mb-3">
                        <label for="calendarSource" class="form-label">Calendar Source</label>
                        <select class="form-control" id="calendarSource" name="source">
                            <option value="canvas">Canvas</option>
                            <option value="github">GitHub</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    <div class="alert alert-info">
                        <p><strong>Tip:</strong> You can export your calendar from Canvas or other platforms as an .ics file, then import it here.</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitIcsUpload">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventDetailsModal" tabindex="-1" aria-labelledby="eventDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailsModalLabel">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Title:</strong> <span id="eventTitle"></span></p>
                <p><strong>Start:</strong> <span id="eventStart"></span></p>
                <p><strong>End:</strong> <span id="eventEnd"></span></p>
                <p><strong>Location:</strong> <span id="eventLocation"></span></p>
                <div id="eventDescriptionContainer">
                    <p><strong>Description:</strong></p>
                    <p id="eventDescription"></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<script>
    // Pass the user's timezone to the clock JavaScript
    const userTimezone = '{{ user.profile.timezone }}';
</script>
<!-- Add Luxon for timezone-aware clock -->
<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="{% static 'js/user-timezone-clock.js' %}"></script>

<script>
    $(document).ready(function() {
        // Setup CSRF token for all AJAX requests
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        // Initialize FullCalendar
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'title',
                center: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth',
                right: 'prev,next,today'
            },
            height: 'auto',
            navLinks: true,
            editable: false,
            selectable: true,
            selectHelper: true,
            nowIndicator: true,
            dayMaxEvents: true,
            events: '/api/calendar/events/',
            eventClassNames: function(arg) {
                // Assign color classes based on event source or type
                if (arg.event.extendedProps.source === 'canvas') {
                    return ['event-primary'];
                } else if (arg.event.extendedProps.source === 'github') {
                    return ['event-success'];
                } else if (arg.event.extendedProps.source === 'deadline') {
                    return ['event-danger'];
                } else if (arg.event.extendedProps.source === 'meeting') {
                    return ['event-warning'];
                } else {
                    return ['event-info'];
                }
            },
            // Adjust view options for different views
            viewDidMount: function(info) {
                // Add specific class based on the view to help with CSS targeting
                if (info.view.type === 'timeGridWeek' || info.view.type === 'timeGridDay') {
                    $('.card-calendar .fc-view-harness').addClass('time-grid-view');
                } else {
                    $('.card-calendar .fc-view-harness').removeClass('time-grid-view');
                }
            },
            loading: function(isLoading) {
                if (isLoading) {
                    // Show loading indicator
                    $('#calendar').append('<div class="fc-loading">Loading...</div>');
                } else {
                    // Remove loading indicator
                    $('.fc-loading').remove();
                }
            },
            eventClick: function(info) {
                // Show event details in modal
                $('#eventTitle').text(info.event.title);
                $('#eventStart').text(formatDate(info.event.start));

                if (info.event.end) {
                    $('#eventEnd').text(formatDate(info.event.end));
                } else {
                    $('#eventEnd').text('N/A');
                }

                if (info.event.extendedProps.location) {
                    $('#eventLocation').text(info.event.extendedProps.location);
                } else {
                    $('#eventLocation').text('N/A');
                }

                if (info.event.extendedProps.description) {
                    $('#eventDescriptionContainer').show();
                    $('#eventDescription').text(info.event.extendedProps.description);
                } else {
                    $('#eventDescriptionContainer').hide();
                }

                $('#eventDetailsModal').modal('show');
            }
        });

        calendar.render();

        // Format date for event details modal
        function formatDate(date) {
            if (!date) return 'N/A';

            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };

            return date.toLocaleDateString(undefined, options);
        }

        // Handle ICS file upload
        $('#submitIcsUpload').click(function() {
            const formData = new FormData($('#uploadIcsForm')[0]);
            const fileInput = $('#icsFile')[0];

            if (fileInput.files.length === 0) {
                alert('Please select a file to upload');
                return;
            }

            $.ajax({
                url: '/api/calendar/upload-ics/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    $('#importIcsModal').modal('hide');

                    // Show success notification
                    $.notify({
                        icon: "nc-icon nc-check-2",
                        message: response.message
                    }, {
                        type: 'success',
                        timer: 4000,
                        placement: {
                            from: 'top',
                            align: 'right'
                        }
                    });

                    // Refresh calendar
                    calendar.refetchEvents();

                    // Reset form
                    $('#uploadIcsForm')[0].reset();
                },
                error: function(xhr) {
                    let errorMessage = 'An error occurred while importing the calendar file.';

                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }

                    // Show error notification
                    $.notify({
                        icon: "nc-icon nc-simple-remove",
                        message: errorMessage
                    }, {
                        type: 'danger',
                        timer: 4000,
                        placement: {
                            from: 'top',
                            align: 'right'
                        }
                    });
                }
            });
        });
    });
</script>
{% endblock %}
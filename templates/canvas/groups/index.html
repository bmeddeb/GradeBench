{% extends 'canvas/base.html' %}
{% load static %}

{% block title %}Groups: {{ course.name }} | GradeBench Canvas{% endblock %}
{% block page_title %}{{ course.course_code }}: {{ course.name }} - Group Management{% endblock %}
{% block nav_canvas_dashboard %}active{% endblock %}

{% block canvas_content %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="card-title mb-0">Group Management</h4>
                    <p class="card-category">Manage Canvas groups and student memberships</p>
                </div>
                <div>
                    <a href="{% url 'canvas_course_detail' course_id=course.canvas_id %}" class="btn btn-sm btn-outline-primary">
                        <i class="fa fa-arrow-left"></i> Back to Course
                    </a>
                    <button id="syncGroupsBtn" class="btn btn-sm btn-primary">
                        <i class="fa fa-refresh"></i> Sync Groups
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="syncProgress" class="progress-container mb-3" style="display: none;">
                    <span id="syncStatusMessage" class="progress-message">Syncing groups...</span>
                    <div class="progress">
                        <div id="syncProgressBar" class="progress-bar progress-bar-primary" role="progressbar" style="width: 0%;">
                        </div>
                    </div>
                </div>
                
                {% if not category_data %}
                <div class="alert alert-info">
                    <p><i class="fa fa-info-circle"></i> No group sets found for this course.</p>
                    <p>Group sets need to be synchronized from Canvas first. Click the "Sync Groups" button above to fetch group sets, groups, and memberships from Canvas.</p>
                </div>
                {% else %}
                <div class="group-management-container">
                    <!-- Group Set Tabs -->
                    <ul class="nav nav-tabs" id="groupSetTabs" role="tablist">
                        {% for cat_data in category_data %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if forloop.first %}active{% endif %}" 
                                    id="groupset-{{ cat_data.category.id }}-tab" 
                                    data-bs-toggle="tab" 
                                    data-bs-target="#groupset-{{ cat_data.category.id }}-content" 
                                    data-category-id="{{ cat_data.category.id }}"
                                    type="button" 
                                    role="tab" 
                                    aria-controls="groupset-{{ cat_data.category.id }}-content" 
                                    aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                                {{ cat_data.category.name }}
                                <span class="badge bg-primary">{{ cat_data.groups_count }}</span>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>
                    
                    <!-- Tab Content -->
                    <div class="tab-content mt-3" id="groupSetTabContent">
                        {% for cat_data in category_data %}
                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" 
                             id="groupset-{{ cat_data.category.id }}-content" 
                             role="tabpanel" 
                             aria-labelledby="groupset-{{ cat_data.category.id }}-tab">
                            
                            <!-- Category Info -->
                            <div class="category-info mb-3">
                                <div class="d-flex justify-content-between">
                                    <h5>{{ cat_data.category.name }}</h5>
                                    <div class="category-actions">
                                        <!-- Read-only in Phase 1 -->
                                        <button class="btn btn-sm btn-primary" disabled>
                                            <i class="fa fa-pencil"></i> Edit (Coming Soon)
                                        </button>
                                    </div>
                                </div>
                                <div class="category-details">
                                    <span class="badge bg-info me-2">
                                        {{ cat_data.groups_count }} Group{% if cat_data.groups_count != 1 %}s{% endif %}
                                    </span>
                                    <span class="badge bg-info">
                                        {{ cat_data.members_count }} Member{% if cat_data.members_count != 1 %}s{% endif %}
                                    </span>

                                    {% if cat_data.category.self_signup %}
                                    <span class="badge bg-success ms-2">Self Sign-up Enabled</span>
                                    {% endif %}

                                    {% if cat_data.category.group_limit %}
                                    <span class="badge bg-warning ms-2">
                                        Limit: {{ cat_data.category.group_limit }} per group
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Groups Loading Placeholder -->
                            <div id="loading-{{ cat_data.category.id }}" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading groups...</span>
                                </div>
                                <p class="mt-2">Loading groups and students...</p>
                            </div>
                            
                            <!-- Groups Container (filled by JavaScript) -->
                            <div id="groups-container-{{ cat_data.category.id }}" class="groups-container" style="display: none;">
                                <!-- Will be filled by JavaScript -->
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="stats">
                    <i class="fa fa-users"></i> {{ total_students }} total student{% if total_students != 1 %}s{% endif %}
                    {% if unassigned_students > 0 %}
                    <span class="ms-3 text-warning">
                        <i class="fa fa-exclamation-triangle"></i> {{ unassigned_students }} unassigned student{% if unassigned_students != 1 %}s{% endif %}
                    </span>
                    {% endif %}
                    
                    {% if last_sync %}
                    <span class="ms-3">
                        <i class="fa fa-clock-o"></i> Last synced: {{ last_sync|date:"M d, Y H:i" }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Group template (for JavaScript rendering) -->
<template id="group-template">
    <div class="card mb-3 group-card">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
            <h6 class="mb-0 group-name"></h6>
            <div class="group-actions">
                <button class="btn btn-sm btn-info view-group-btn" disabled>
                    <i class="fa fa-eye"></i> View (Coming Soon)
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="group-description mb-2"></p>
            <div class="group-members">
                <h6 class="mb-2">Members:</h6>
                <ul class="list-group list-group-flush members-list">
                    <!-- Members will be added here -->
                </ul>
            </div>
        </div>
    </div>
</template>

<!-- Member template (for JavaScript rendering) -->
<template id="member-template">
    <li class="list-group-item d-flex justify-content-between align-items-center">
        <span class="member-name"></span>
        <span class="member-email"></span>
    </li>
</template>

<!-- Unassigned students template -->
<template id="unassigned-students-template">
    <div class="card mb-3 unassigned-students-card">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
            <h6 class="mb-0">Unassigned Students</h6>
            <div class="unassigned-actions">
                <button class="btn btn-sm btn-warning random-assign-btn" disabled>
                    <i class="fa fa-random"></i> Random Assign (Coming Soon)
                </button>
            </div>
        </div>
        <div class="card-body">
            <ul class="list-group list-group-flush unassigned-list">
                <!-- Unassigned students will be added here -->
            </ul>
        </div>
    </div>
</template>
{% endblock %}

{% block canvas_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tabs with data loading
        const groupSetTabs = document.querySelectorAll('#groupSetTabs .nav-link');
        let activeTabLoaded = false;
        
        // Add click event to tabs
        groupSetTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-category-id');
                loadGroupSetData(categoryId);
            });
        });
        
        // Load data for the active tab on page load
        if (groupSetTabs.length > 0) {
            const activeTab = document.querySelector('#groupSetTabs .nav-link.active');
            if (activeTab) {
                const categoryId = activeTab.getAttribute('data-category-id');
                loadGroupSetData(categoryId);
            }
        }
        
        // Handle sync button
        const syncButton = document.getElementById('syncGroupsBtn');
        if (syncButton) {
            syncButton.addEventListener('click', function() {
                syncGroups();
            });
        }
        
        // Function to load group set data
        function loadGroupSetData(categoryId) {
            // If data is already loaded, no need to reload
            const container = document.getElementById(`groups-container-${categoryId}`);
            if (container && container.hasAttribute('data-loaded')) {
                return;
            }
            
            // Show loading indicator
            const loadingElement = document.getElementById(`loading-${categoryId}`);
            if (loadingElement) {
                loadingElement.style.display = 'block';
            }
            if (container) {
                container.style.display = 'none';
            }
            
            // Fetch group set details
            fetch(`/canvas/course/{{ course.canvas_id }}/group_set/${categoryId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error fetching group set data');
                    }
                    return response.json();
                })
                .then(data => {
                    renderGroupSetData(categoryId, data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    if (container) {
                        container.innerHTML = `<div class="alert alert-danger">Error loading group data: ${error.message}</div>`;
                        container.style.display = 'block';
                    }
                })
                .finally(() => {
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                });
        }
        
        // Function to render group set data
        function renderGroupSetData(categoryId, data) {
            const container = document.getElementById(`groups-container-${categoryId}`);
            if (!container) return;
            
            // Clear existing content
            container.innerHTML = '';
            
            // Create row for groups
            const row = document.createElement('div');
            row.className = 'row';
            
            // Render each group
            data.groups.forEach(group => {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6 mb-3';
                
                // Clone group template
                const template = document.getElementById('group-template');
                const groupCard = template.content.cloneNode(true);
                
                // Fill group data
                groupCard.querySelector('.group-name').textContent = group.name;
                
                const description = groupCard.querySelector('.group-description');
                if (group.description) {
                    description.textContent = group.description;
                } else {
                    description.textContent = 'No description';
                }
                
                // Fill member list
                const membersList = groupCard.querySelector('.members-list');
                if (group.members && group.members.length > 0) {
                    group.members.forEach(member => {
                        const memberTemplate = document.getElementById('member-template');
                        const memberItem = memberTemplate.content.cloneNode(true);
                        
                        memberItem.querySelector('.member-name').textContent = member.name;
                        memberItem.querySelector('.member-email').textContent = member.email || '';
                        
                        membersList.appendChild(memberItem);
                    });
                } else {
                    const emptyItem = document.createElement('li');
                    emptyItem.className = 'list-group-item py-1 px-2 text-muted';
                    emptyItem.textContent = 'No members';
                    membersList.appendChild(emptyItem);
                }
                
                col.appendChild(groupCard);
                row.appendChild(col);
            });
            
            // Add unassigned students if any
            if (data.unassigned_students && data.unassigned_students.length > 0) {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6 mb-3';
                
                const template = document.getElementById('unassigned-students-template');
                const unassignedCard = template.content.cloneNode(true);
                
                const unassignedList = unassignedCard.querySelector('.unassigned-list');
                
                data.unassigned_students.forEach(student => {
                    const memberTemplate = document.getElementById('member-template');
                    const memberItem = memberTemplate.content.cloneNode(true);
                    
                    memberItem.querySelector('.member-name').textContent = student.user_name;
                    memberItem.querySelector('.member-email').textContent = student.email || '';
                    
                    unassignedList.appendChild(memberItem);
                });
                
                col.appendChild(unassignedCard);
                row.appendChild(col);
            }
            
            container.appendChild(row);
            container.setAttribute('data-loaded', 'true');
            container.style.display = 'block';
        }
        
        // Function to sync groups
        function syncGroups() {
            // Show sync progress
            const syncProgress = document.getElementById('syncProgress');
            const syncProgressBar = document.getElementById('syncProgressBar');
            const syncStatusMessage = document.getElementById('syncStatusMessage');

            syncProgress.style.display = 'block';
            syncProgressBar.style.width = '0%';
            syncStatusMessage.textContent = 'Starting group sync...';

            // Disable sync button
            const syncButton = document.getElementById('syncGroupsBtn');
            if (syncButton) {
                syncButton.disabled = true;
            }

            // Use the groups-specific sync endpoint for better efficiency
            fetch(`/canvas/course/{{ course.canvas_id }}/sync_groups/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                // The sync happens in the background, so we'll poll for progress
                checkSyncProgress();
            })
            .catch(error => {
                console.error('Error starting sync:', error);
                syncStatusMessage.textContent = 'Error starting sync: ' + error.message;
                if (syncButton) {
                    syncButton.disabled = false;
                }
            });
        }
        
        // Function to check sync progress
        function checkSyncProgress() {
            const intervalId = setInterval(() => {
                fetch(`/canvas/sync_progress/?course_id={{ course.canvas_id }}`)
                    .then(response => response.json())
                    .then(data => {
                        updateProgressUI(data);
                        
                        // Check if sync is complete
                        if (data.status === 'completed' || data.status === 'error') {
                            clearInterval(intervalId);
                            
                            // Re-enable sync button
                            const syncButton = document.getElementById('syncGroupsBtn');
                            if (syncButton) {
                                syncButton.disabled = false;
                            }
                            
                            // Reload the page after a slight delay if successful
                            if (data.status === 'completed') {
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking sync progress:', error);
                        clearInterval(intervalId);
                        
                        // Re-enable sync button
                        const syncButton = document.getElementById('syncGroupsBtn');
                        if (syncButton) {
                            syncButton.disabled = false;
                        }
                    });
            }, 1000); // Poll every second
        }
        
        // Function to update progress UI
        function updateProgressUI(data) {
            const syncProgressBar = document.getElementById('syncProgressBar');
            const syncStatusMessage = document.getElementById('syncStatusMessage');
            
            if (data.current !== undefined && data.total !== undefined) {
                const percent = (data.current / data.total) * 100;
                syncProgressBar.style.width = `${percent}%`;
            }
            
            if (data.message) {
                syncStatusMessage.textContent = data.message;
            }
            
            // Update progress bar class based on status
            if (data.status === 'completed') {
                syncProgressBar.className = 'progress-bar progress-bar-success';
            } else if (data.status === 'error') {
                syncProgressBar.className = 'progress-bar progress-bar-danger';
            } else {
                syncProgressBar.className = 'progress-bar progress-bar-primary';
            }
        }
    });
</script>
{% endblock %}

{% block canvas_css %}
<style>
    /* Card styling */
    .group-card {
        height: 100%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #dee2e6;
    }

    .group-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
    }

    .group-card .card-body {
        max-height: 250px;
        overflow-y: auto;
        padding: 1rem;
    }

    /* Unassigned students styling */
    .unassigned-students-card {
        height: 100%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ffeeba;
    }

    .unassigned-students-card .card-body {
        max-height: 250px;
        overflow-y: auto;
        padding: 1rem;
    }

    .unassigned-students-card .card-header {
        background-color: #fff3cd;
        border-bottom: 1px solid #ffeeba;
        color: #856404;
        font-weight: 600;
    }

    /* Button styling */
    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
    }

    .btn-outline-secondary:disabled {
        color: #6c757d;
        background-color: transparent;
        border-color: #6c757d;
        opacity: 0.65;
    }

    .view-group-btn, .random-assign-btn {
        color: #495057;
        border-color: #6c757d;
    }

    /* Progress container */
    .progress-container {
        margin-bottom: 20px;
    }

    .progress-message {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .progress {
        height: 0.75rem;
        background-color: #e9ecef;
    }

    .progress-bar {
        background-color: #007bff;
    }

    /* Member lists */
    .members-list .list-group-item,
    .unassigned-list .list-group-item {
        border-left: none;
        border-right: none;
        padding: 0.5rem 0.75rem;
    }

    .members-list .list-group-item:first-child,
    .unassigned-list .list-group-item:first-child {
        border-top: none;
    }

    .member-name {
        font-weight: 500;
        color: #212529;
    }

    .member-email {
        color: #6c757d;
        font-size: 0.85rem;
    }

    /* Tab styling */
    .nav-tabs {
        border-bottom: 1px solid #dee2e6;
    }

    .nav-tabs .nav-link {
        color: #495057;
        border: 1px solid transparent;
    }

    .nav-tabs .nav-link.active {
        color: #007bff;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
        font-weight: 600;
    }

    .nav-tabs .nav-link:hover {
        border-color: #e9ecef #e9ecef #dee2e6;
    }

    /* Category details */
    .category-info {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.25rem;
        border: 1px solid #e9ecef;
    }

    .category-details {
        margin-top: 0.5rem;
    }

    .badge {
        padding: 0.4em 0.6em;
    }

    .initially-hidden {
        display: none;
    }

    /* Group description */
    .group-description {
        margin-bottom: 0.75rem;
        color: #495057;
    }
</style>
{% endblock %}
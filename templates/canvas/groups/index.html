{% extends 'canvas/base.html' %}
{% load static %}

{% block title %}Groups: {{ course.name }} | GradeBench Canvas{% endblock %}
{% block page_title %}{{ course.course_code }}: {{ course.name }} - Group Management{% endblock %}
{% block nav_canvas_dashboard %}active{% endblock %}

{% block extra_head %}
<!-- Add course ID for JavaScript access -->
<meta name="course-id" content="{{ course.id }}">
{% endblock %}

{% block canvas_content %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="card-title mb-0">Group Management</h4>
                    <p class="card-category">Manage Canvas groups and student memberships</p>
                </div>
                <div>
                    <a href="{% url 'canvas_course_detail' course_id=course.canvas_id %}" class="btn btn-sm btn-outline-primary">
                        <i class="fa fa-arrow-left"></i> Back to Course
                    </a>
                    <a href="{% url 'canvas_create_group_set' course_id=course.canvas_id %}" class="btn btn-sm btn-success">
                        <i class="fa fa-plus"></i> New Group Set
                    </a>
                    <button id="syncGroupsBtn" class="btn btn-sm btn-primary">
                        <i class="fa fa-refresh"></i> Sync Groups
                    </button>
                    <a href="{% url 'canvas_push_group_memberships' course_id=course.canvas_id %}" class="btn btn-sm btn-info">
                        <i class="fa fa-upload"></i> Push Memberships
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div id="syncProgress" class="progress-container mb-3" style="display: none;">
                    <span id="syncStatusMessage" class="progress-message">Syncing groups...</span>
                    <div class="progress">
                        <div id="syncProgressBar" class="progress-bar progress-bar-primary" role="progressbar" style="width: 0%;">
                        </div>
                    </div>
                </div>

                {% if not category_data %}
                <div class="alert alert-info">
                    <p><i class="fa fa-info-circle"></i> No group sets found for this course.</p>
                    <p>Group sets need to be synchronized from Canvas first. Click the "Sync Groups" button above to fetch group sets, groups, and memberships from Canvas.</p>
                </div>
                {% else %}
                <div class="group-management-container">
                    <!-- Group Set Tabs -->
                    <ul class="nav nav-tabs" id="groupSetTabs" role="tablist">
                        {% for cat_data in category_data %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if forloop.first %}active{% endif %}"
                                    id="groupset-{{ cat_data.category.id }}-tab"
                                    data-bs-toggle="tab"
                                    data-bs-target="#groupset-{{ cat_data.category.id }}-content"
                                    data-category-id="{{ cat_data.category.id }}"
                                    type="button"
                                    role="tab"
                                    aria-controls="groupset-{{ cat_data.category.id }}-content"
                                    aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                                {{ cat_data.category.name }}
                                <span class="badge bg-primary">{{ cat_data.groups_count }}</span>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-3" id="groupSetTabContent">
                        {% for cat_data in category_data %}
                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                             id="groupset-{{ cat_data.category.id }}-content"
                             role="tabpanel"
                             aria-labelledby="groupset-{{ cat_data.category.id }}-tab">

                            <!-- Category Info -->
                            <div class="category-info mb-3">
                                <div class="d-flex justify-content-between">
                                    <h5>{{ cat_data.category.name }}</h5>
                                    <div class="category-actions">
                                        <a href="{% url 'canvas_edit_group_set' course_id=course.canvas_id group_set_id=cat_data.category.id %}" class="btn btn-sm btn-primary">
                                            <i class="fa fa-pencil"></i> Edit
                                        </a>
                                        <button class="btn btn-sm btn-danger delete-group-set-btn"
                                                data-category-id="{{ cat_data.category.id }}"
                                                data-category-name="{{ cat_data.category.name }}">
                                            <i class="fa fa-trash"></i> Delete
                                        </button>
                                        <a href="{% url 'canvas_create_group_alias' course_id=course.canvas_id group_set_id=cat_data.category.id %}" class="btn btn-sm btn-success">
                                            <i class="fa fa-plus"></i> Add Group
                                        </a>
                                    </div>
                                </div>
                                <div class="category-details">
                                    <span class="badge bg-info me-2">
                                        {{ cat_data.groups_count }} Group{% if cat_data.groups_count != 1 %}s{% endif %}
                                    </span>
                                    <span class="badge bg-info">
                                        {{ cat_data.members_count }} Member{% if cat_data.members_count != 1 %}s{% endif %}
                                    </span>

                                    {% if cat_data.category.self_signup %}
                                    <span class="badge bg-success ms-2">Self Sign-up Enabled</span>
                                    {% endif %}

                                    {% if cat_data.category.group_limit %}
                                    <span class="badge bg-warning ms-2">
                                        Limit: {{ cat_data.category.group_limit }} per group
                                    </span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Groups Loading Placeholder -->
                            <div id="loading-{{ cat_data.category.id }}" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading groups...</span>
                                </div>
                                <p class="mt-2">Loading groups and students...</p>
                            </div>

                            <!-- Groups Container (filled by JavaScript) -->
                            <div id="groups-container-{{ cat_data.category.id }}" class="groups-container" style="display: none;">
                                <!-- Will be filled by JavaScript -->
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="stats">
                    <i class="fa fa-users"></i> {{ total_students }} total student{% if total_students != 1 %}s{% endif %}
                    {% if unassigned_students > 0 %}
                    <span class="ms-3 text-warning">
                        <i class="fa fa-exclamation-triangle"></i> {{ unassigned_students }} unassigned student{% if unassigned_students != 1 %}s{% endif %}
                    </span>
                    {% endif %}

                    {% if last_sync %}
                    <span class="ms-3">
                        <i class="fa fa-clock-o"></i> Last synced: {{ last_sync|date:"M d, Y H:i" }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Group template (for JavaScript rendering) -->
<template id="group-template">
    <div class="card mb-3 group-card">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
            <h6 class="mb-0 group-name"></h6>
            <div class="group-actions">
                <a href="#" class="btn btn-sm btn-primary edit-group-btn">
                    <i class="fa fa-pencil"></i> Edit
                </a>
                <button class="btn btn-sm btn-danger delete-group-btn">
                    <i class="fa fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="group-description mb-2"></p>
            <div class="group-members">
                <h6 class="mb-2">Members:</h6>
                <ul class="list-group list-group-flush members-list">
                    <!-- Members will be added here -->
                </ul>
            </div>
        </div>
    </div>
</template>

<!-- Member template (for JavaScript rendering) -->
<template id="member-template">
    <li class="list-group-item student-item d-flex justify-content-between align-items-center">
        <div class="student-info">
            <span class="member-name"></span>
            <small class="student-email"></small>
        </div>
        <span class="drag-handle" title="Drag to move student">
            <i class="fa fa-grip-lines"></i>
        </span>
    </li>
</template>

<!-- Unassigned students template -->
<template id="unassigned-students-template">
    <div class="card mb-3 unassigned-students-card">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
            <h6 class="mb-0">Unassigned Students</h6>
            <div class="unassigned-actions">
                <button class="btn btn-sm btn-warning random-assign-btn">
                    <i class="fa fa-random"></i> Random Assign
                </button>
            </div>
        </div>
        <div class="card-body">
            <ul class="list-group list-group-flush unassigned-list">
                <!-- Unassigned students will be added here -->
            </ul>
        </div>
    </div>
</template>

<!-- Save changes banner -->
<div id="saveChangesBanner" class="save-changes-banner">
    <div class="banner-message">
        <strong>Unsaved changes!</strong> You have made changes to student assignments that haven't been saved.
    </div>
    <div class="banner-actions">
        <button id="discardChangesBtn" class="btn btn-sm btn-secondary me-2">Discard Changes</button>
        <button id="saveChangesBtn" class="btn btn-sm btn-warning">Save Changes</button>
    </div>
</div>

<!-- Confirmation Modal for Deleting -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmDeleteModalBody">
        Are you sure you want to delete this item?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- CSRF token for AJAX requests -->
{% csrf_token %}
{% endblock %}

{% block canvas_js %}
<!-- Directly include SortableJS first -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- Use final version with drag and drop functionality -->
<script src="{% static 'js/canvas-group-sortable-fixed.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize modal
        let deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        let confirmDeleteButton = document.getElementById('confirmDeleteButton');
        let currentDeleteAction = null;

        // Initialize tabs with data loading
        const groupSetTabs = document.querySelectorAll('#groupSetTabs .nav-link');
        let activeTabLoaded = false;

        // Add click event to tabs
        groupSetTabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const categoryId = this.getAttribute('data-category-id');
                loadGroupSetData(categoryId);

                // Update URL hash (for bookmarking and history)
                window.location.hash = `category-${categoryId}`;
            });
        });

        // Function to select a tab by category ID
        function selectTabByCategory(categoryId) {
            // Find the tab for this category
            const tab = document.querySelector(`#groupSetTabs .nav-link[data-category-id="${categoryId}"]`);
            if (tab) {
                // Get the Bootstrap tab instance
                const bsTab = new bootstrap.Tab(tab);
                // Show this tab
                bsTab.show();
                // Load data for this category
                loadGroupSetData(categoryId);
                return true;
            }
            return false;
        }

        // Check URL hash for category ID on page load
        const hashMatch = window.location.hash.match(/^#category-(\d+)$/);
        if (hashMatch && hashMatch[1]) {
            // Try to select the tab based on the hash
            const selectedCategory = hashMatch[1];
            if (selectTabByCategory(selectedCategory)) {
                // Successfully selected tab
                console.log(`Selected category ${selectedCategory} from URL hash`);
            } else {
                // Fallback to default tab
                const activeTab = document.querySelector('#groupSetTabs .nav-link.active');
                if (activeTab) {
                    const categoryId = activeTab.getAttribute('data-category-id');
                    loadGroupSetData(categoryId);
                }
            }
        } else {
            // No hash or invalid hash, load default tab
            if (groupSetTabs.length > 0) {
                const activeTab = document.querySelector('#groupSetTabs .nav-link.active');
                if (activeTab) {
                    const categoryId = activeTab.getAttribute('data-category-id');
                    loadGroupSetData(categoryId);
                }
            }
        }

        // Handle sync button
        const syncButton = document.getElementById('syncGroupsBtn');
        if (syncButton) {
            syncButton.addEventListener('click', function() {
                syncGroups();
            });
        }

        // Add event delegation for delete group set buttons
        document.addEventListener('click', function(e) {
            if (e.target && e.target.closest('.delete-group-set-btn')) {
                const btn = e.target.closest('.delete-group-set-btn');
                const categoryId = btn.getAttribute('data-category-id');
                const categoryName = btn.getAttribute('data-category-name');

                // Show confirmation modal
                document.getElementById('confirmDeleteModalBody').textContent =
                    `Are you sure you want to delete the group set "${categoryName}"? This will delete all groups within this set.`;

                // Set up the delete action
                currentDeleteAction = () => deleteGroupSet(categoryId);
                deleteModal.show();
            }
        });

        // Set up confirm delete button
        if (confirmDeleteButton) {
            confirmDeleteButton.addEventListener('click', function() {
                if (currentDeleteAction) {
                    // Hide modal
                    deleteModal.hide();

                    // Call the delete function
                    currentDeleteAction();

                    // Reset current action
                    currentDeleteAction = null;
                }
            });
        }

        // Function to delete a group set
        function deleteGroupSet(categoryId) {
            // Create a POST request with CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Show the delete operation in progress 
            const modal = document.getElementById('confirmDeleteModal');
            const modalBody = document.getElementById('confirmDeleteModalBody');
            const confirmButton = document.getElementById('confirmDeleteButton');
            const closeButton = modal.querySelector('.btn-close');
            const cancelButton = modal.querySelector('.btn-secondary');

            // Disable buttons and show spinner
            confirmButton.disabled = true;
            closeButton.disabled = true;
            cancelButton.disabled = true;
            
            // Replace current text with a loading indicator
            const originalText = modalBody.innerHTML;
            modalBody.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Deleting group set...</span>
                    </div>
                    <p class="mt-2">Deleting group set and updating Canvas...</p>
                    <p class="text-muted small">This may take a moment to complete.</p>
                </div>
            `;

            fetch(`/canvas/course/{{ course.canvas_id }}/group_set/${categoryId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message using notify instead of alert
                    if (typeof $ !== 'undefined' && typeof $.notify === 'function') {
                        $.notify({
                            message: data.message
                        }, {
                            type: 'success',
                            placement: { from: 'top', align: 'center' },
                            z_index: 2000,
                            delay: 3000
                        });
                    }

                    // Reload the page
                    window.location.reload();
                } else {
                    // Restore original modal content
                    modalBody.innerHTML = originalText;
                    
                    // Re-enable buttons
                    confirmButton.disabled = false;
                    closeButton.disabled = false;
                    cancelButton.disabled = false;
                    
                    // Show error message
                    if (typeof $ !== 'undefined' && typeof $.notify === 'function') {
                        $.notify({
                            message: `Error: ${data.error}`
                        }, {
                            type: 'danger',
                            placement: { from: 'top', align: 'center' },
                            z_index: 2000,
                            delay: 5000
                        });
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                }
            })
            .catch(error => {
                console.error('Error deleting group set:', error);
                
                // Restore original modal content
                modalBody.innerHTML = originalText;
                
                // Re-enable buttons
                confirmButton.disabled = false;
                closeButton.disabled = false;
                cancelButton.disabled = false;
                
                // Show error message
                if (typeof $ !== 'undefined' && typeof $.notify === 'function') {
                    $.notify({
                        message: 'An error occurred while deleting the group set. Please try again.'
                    }, {
                        type: 'danger',
                        placement: { from: 'top', align: 'center' },
                        z_index: 2000,
                        delay: 5000
                    });
                } else {
                    alert('An error occurred while deleting the group set. Please try again.');
                }
            });
        }

        // Function to load group set data
        function loadGroupSetData(categoryId) {
            const container = document.getElementById(`groups-container-${categoryId}`);
            const loadingElement = document.getElementById(`loading-${categoryId}`);

            if (container) {
                // Only fetch if not already loaded
                if (container.getAttribute('data-loaded') !== 'true') {
                    if (loadingElement) {
                        loadingElement.style.display = 'block';
                    }

                    // Fetch the data for this group set
                    fetch(`/canvas/course/{{ course.canvas_id }}/group_set/${categoryId}/details/`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Error fetching group set data');
                            }
                            return response.json();
                        })
                        .then(data => {
                            renderGroupSetData(categoryId, data);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            if (container) {
                                container.innerHTML = `<div class="alert alert-danger">Error loading group data: ${error.message}</div>`;
                                container.style.display = 'block';
                            }
                        })
                        .finally(() => {
                            if (loadingElement) {
                                loadingElement.style.display = 'none';
                            }
                        });
                }
            }
        }

        // Function to render group set data
        function renderGroupSetData(categoryId, data) {
            const container = document.getElementById(`groups-container-${categoryId}`);
            if (!container) return;

            // Verify we have all necessary data
            if (!data) {
                container.innerHTML = '<div class="alert alert-danger">Error: No data received from server</div>';
                return;
            }

            // Make sure we have a category object
            if (!data.category) {
                data.category = { id: categoryId, name: "Unknown" };
            }

            // Make sure we have a groups array
            if (!data.groups) {
                data.groups = [];
            }

            // Make sure we have an unassigned_students array
            if (!data.unassigned_students) {
                data.unassigned_students = [];
            }

            // Add course reference for creating links
            if (!data.course) {
                // Try to get from URL
                const courseIdMatch = window.location.pathname.match(/\/course\/(\d+)/);
                if (courseIdMatch && courseIdMatch[1]) {
                    data.course = { id: courseIdMatch[1] };
                }
            }

            // Clear existing content
            container.innerHTML = '';

            // Set data-category-id on the tab pane for easier access
            const tabPane = document.getElementById(`groupset-${categoryId}-content`);
            if (tabPane) {
                tabPane.setAttribute('data-category-id', categoryId);
            }

            // Create row for groups
            const row = document.createElement('div');
            row.className = 'row';

            // Check if there are any groups
            const hasGroups = data.groups && data.groups.length > 0;

            // Render each group
            if (hasGroups) {
                data.groups.forEach(group => {
                    const col = document.createElement('div');
                    col.className = 'col-md-4 col-sm-6 mb-3';

                    // Clone group template
                    const template = document.getElementById('group-template');
                    const groupCard = template.content.cloneNode(true);

                // Add data attributes to the card for drag-and-drop
                const cardElement = groupCard.querySelector('.group-card');
                cardElement.setAttribute('data-group-id', group.id);
                cardElement.setAttribute('data-canvas-group-id', group.canvas_id);

                // Fill group data
                groupCard.querySelector('.group-name').textContent = group.name;

                // Set up edit link
                const editLink = groupCard.querySelector('.edit-group-btn');
                editLink.href = `/canvas/course/{{ course.canvas_id }}/group/${group.id}/edit/`;

                // Set up delete button
                const deleteBtn = groupCard.querySelector('.delete-group-btn');
                deleteBtn.setAttribute('data-group-id', group.id);
                deleteBtn.setAttribute('data-group-name', group.name);
                deleteBtn.addEventListener('click', function() {
                    // Show confirmation modal
                    document.getElementById('confirmDeleteModalBody').textContent =
                        `Are you sure you want to delete the group "${group.name}"?`;

                    // Set up the delete action
                    currentDeleteAction = () => deleteGroup(group.id);
                    deleteModal.show();
                });

                const description = groupCard.querySelector('.group-description');
                if (group.description) {
                    description.textContent = group.description;
                } else {
                    description.textContent = 'No description';
                }

                // Fill member list
                const membersList = groupCard.querySelector('.members-list');
                membersList.classList.add('sortable-container');

                if (group.members && group.members.length > 0) {
                    group.members.forEach(member => {
                        const memberTemplate = document.getElementById('member-template');
                        const memberItem = memberTemplate.content.cloneNode(true);

                        // Add data attributes for drag-and-drop
                        const li = memberItem.querySelector('.student-item');
                        li.setAttribute('data-student-id', member.user_id);
                        li.setAttribute('data-student-name', member.name);
                        li.setAttribute('data-student-email', member.email || '');

                        memberItem.querySelector('.member-name').textContent = member.name;
                        memberItem.querySelector('.student-email').textContent = member.email || '';

                        membersList.appendChild(memberItem);
                    });
                } else {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'empty-group-placeholder';
                    emptyItem.innerHTML = '<i class="fa fa-users me-2"></i>No members - drag students here';
                    membersList.appendChild(emptyItem);
                }

                    col.appendChild(groupCard);
                    row.appendChild(col);
                });
            } else {
                // Show message if no groups exist
                const noGroupsCol = document.createElement('div');
                noGroupsCol.className = 'col-12 mb-3';

                const noGroupsCard = document.createElement('div');
                noGroupsCard.className = 'card no-groups-message';

                const cardBody = document.createElement('div');
                cardBody.className = 'card-body text-center py-4';

                const icon = document.createElement('i');
                icon.className = 'fa fa-users-slash fa-3x mb-3 text-muted';

                const heading = document.createElement('h5');
                heading.className = 'mb-3';
                heading.textContent = 'No Groups Available';

                const message = document.createElement('p');
                message.className = 'mb-3';
                message.textContent = 'There are no groups in this category yet. Create groups to manually or randomly assign students.';

                // Get course ID from meta tag or data
                const courseId = document.querySelector('meta[name="course-id"]')?.content ||
                                (data.course && data.course.id ? data.course.id : null);

                const createGroupBtn = document.createElement('a');
                if (courseId && data.category && data.category.id) {
                    createGroupBtn.href = `/canvas/course/${courseId}/group_set/${data.category.id}/group/create/`;
                    createGroupBtn.className = 'btn btn-primary';
                    createGroupBtn.innerHTML = '<i class="fa fa-plus"></i> Create Group';
                } else {
                    // If we can't build the URL, make it a disabled button instead
                    createGroupBtn.className = 'btn btn-secondary disabled';
                    createGroupBtn.innerHTML = '<i class="fa fa-plus"></i> Create Group';
                    createGroupBtn.setAttribute('aria-disabled', 'true');
                }

                cardBody.appendChild(icon);
                cardBody.appendChild(heading);
                cardBody.appendChild(message);
                cardBody.appendChild(createGroupBtn);

                noGroupsCard.appendChild(cardBody);
                noGroupsCol.appendChild(noGroupsCard);
                row.appendChild(noGroupsCol);
            }

            // Add unassigned students if any
            if (data.unassigned_students && data.unassigned_students.length > 0) {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6 mb-3';

                const template = document.getElementById('unassigned-students-template');
                const unassignedCard = template.content.cloneNode(true);

                // Add class to unassigned card for identification
                const unassignedCardElement = unassignedCard.querySelector('.unassigned-students-card');
                unassignedCardElement.setAttribute('data-is-unassigned', 'true');

                const unassignedList = unassignedCard.querySelector('.unassigned-list');
                const randomAssignBtn = unassignedCard.querySelector('.random-assign-btn');

                // Set category data for random assignment if available
                if (data.category && data.category.id) {
                    randomAssignBtn.setAttribute('data-category-id', data.category.id);
                }

                // Disable random assign button if there are no groups
                if (!hasGroups) {
                    randomAssignBtn.disabled = true;
                    randomAssignBtn.setAttribute('title', 'Create groups first before randomly assigning students');
                    randomAssignBtn.classList.add('disabled');

                    // Add info icon with tooltip
                    const infoIcon = document.createElement('i');
                    infoIcon.className = 'fa fa-info-circle ms-1';
                    infoIcon.setAttribute('title', 'Create groups first before randomly assigning students');
                    randomAssignBtn.appendChild(infoIcon);
                } else {
                    // Add event listener for random assignment (only if groups exist)
                    randomAssignBtn.addEventListener('click', function() {
                        randomAssignStudents(data.category.id);
                    });
                }

                // Add sortable class to unassigned list
                unassignedList.classList.add('sortable-container');

                data.unassigned_students.forEach(student => {
                    const memberTemplate = document.getElementById('member-template');
                    const memberItem = memberTemplate.content.cloneNode(true);

                    // Add data attributes for drag-and-drop
                    const li = memberItem.querySelector('.student-item');
                    li.setAttribute('data-student-id', student.user_id);
                    li.setAttribute('data-student-name', student.user_name);
                    li.setAttribute('data-student-email', student.email || '');

                    memberItem.querySelector('.member-name').textContent = student.user_name;
                    memberItem.querySelector('.student-email').textContent = student.email || '';

                    unassignedList.appendChild(memberItem);
                });

                col.appendChild(unassignedCard);
                row.appendChild(col);
            }

            container.appendChild(row);
            container.setAttribute('data-loaded', 'true');
            container.style.display = 'block';

            // Dispatch custom event to initialize sortable
            document.dispatchEvent(new CustomEvent('groupDataLoaded', {
                detail: { categoryId: categoryId }
            }));
        }

        // Function to delete a group
        function deleteGroup(groupId) {
            // Create a POST request with CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // Show the delete operation in progress 
            const modal = document.getElementById('confirmDeleteModal');
            const modalBody = document.getElementById('confirmDeleteModalBody');
            const confirmButton = document.getElementById('confirmDeleteButton');
            const closeButton = modal.querySelector('.btn-close');
            const cancelButton = modal.querySelector('.btn-secondary');

            // Disable buttons and show spinner
            confirmButton.disabled = true;
            closeButton.disabled = true;
            cancelButton.disabled = true;
            
            // Replace current text with a loading indicator
            const originalText = modalBody.innerHTML;
            modalBody.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Deleting group...</span>
                    </div>
                    <p class="mt-2">Deleting group and updating Canvas...</p>
                </div>
            `;

            fetch(`/canvas/course/{{ course.canvas_id }}/group/${groupId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close the modal
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    modalInstance.hide();

                    // Show success message using notify
                    if (typeof $ !== 'undefined' && typeof $.notify === 'function') {
                        $.notify({
                            message: data.message
                        }, {
                            type: 'success',
                            placement: { from: 'top', align: 'center' },
                            z_index: 2000,
                            delay: 3000
                        });
                    }

                    // Reload the active tab data
                    const activeTab = document.querySelector('#groupSetTabs .nav-link.active');
                    if (activeTab) {
                        const categoryId = activeTab.getAttribute('data-category-id');
                        const container = document.getElementById(`groups-container-${categoryId}`);
                        if (container) {
                            container.removeAttribute('data-loaded');
                        }
                        loadGroupSetData(categoryId);
                    }
                } else {
                    // Restore original modal content
                    modalBody.innerHTML = originalText;
                    
                    // Re-enable buttons
                    confirmButton.disabled = false;
                    closeButton.disabled = false;
                    cancelButton.disabled = false;
                    
                    // Show error message
                    if (typeof $ !== 'undefined' && typeof $.notify === 'function') {
                        $.notify({
                            message: `Error: ${data.error}`
                        }, {
                            type: 'danger',
                            placement: { from: 'top', align: 'center' },
                            z_index: 2000,
                            delay: 5000
                        });
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                }
            })
            .catch(error => {
                console.error('Error deleting group:', error);
                
                // Restore original modal content
                modalBody.innerHTML = originalText;
                
                // Re-enable buttons
                confirmButton.disabled = false;
                closeButton.disabled = false;
                cancelButton.disabled = false;
                
                // Show error message
                if (typeof $ !== 'undefined' && typeof $.notify === 'function') {
                    $.notify({
                        message: 'An error occurred while deleting the group. Please try again.'
                    }, {
                        type: 'danger',
                        placement: { from: 'top', align: 'center' },
                        z_index: 2000,
                        delay: 5000
                    });
                } else {
                    alert('An error occurred while deleting the group. Please try again.');
                }
            });
        }

        // Function to random assign students is now implemented in canvas-group-sortable.js
        // This function is called from the random assign button

        // Function to sync groups
        function syncGroups() {
            // Show sync progress
            const syncProgress = document.getElementById('syncProgress');
            const syncProgressBar = document.getElementById('syncProgressBar');
            const syncStatusMessage = document.getElementById('syncStatusMessage');

            syncProgress.style.display = 'block';
            syncProgressBar.style.width = '0%';
            syncStatusMessage.textContent = 'Starting group sync...';

            // Disable sync button
            const syncButton = document.getElementById('syncGroupsBtn');
            if (syncButton) {
                syncButton.disabled = true;
            }

            // Use the groups-specific sync endpoint for better efficiency
            fetch(`/canvas/course/{{ course.canvas_id }}/sync_groups/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                // The sync happens in the background, so we'll poll for progress
                checkSyncProgress();
            })
            .catch(error => {
                console.error('Error starting sync:', error);
                syncStatusMessage.textContent = 'Error starting sync: ' + error.message;
                if (syncButton) {
                    syncButton.disabled = false;
                }
            });
        }

        // Function to check sync progress
        function checkSyncProgress() {
            const intervalId = setInterval(() => {
                fetch(`/canvas/sync_progress/?course_id={{ course.canvas_id }}`)
                    .then(response => response.json())
                    .then(data => {
                        updateProgressUI(data);

                        // Check if sync is complete
                        if (data.status === 'completed' || data.status === 'error') {
                            clearInterval(intervalId);

                            // Re-enable sync button
                            const syncButton = document.getElementById('syncGroupsBtn');
                            if (syncButton) {
                                syncButton.disabled = false;
                            }

                            // Reload the page after a slight delay if successful
                            if (data.status === 'completed') {
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error checking sync progress:', error);
                        clearInterval(intervalId);

                        // Re-enable sync button
                        const syncButton = document.getElementById('syncGroupsBtn');
                        if (syncButton) {
                            syncButton.disabled = false;
                        }
                    });
            }, 1000); // Poll every second
        }

        // Function to update progress UI
        function updateProgressUI(data) {
            const syncProgressBar = document.getElementById('syncProgressBar');
            const syncStatusMessage = document.getElementById('syncStatusMessage');

            if (data.current !== undefined && data.total !== undefined) {
                const percent = (data.current / data.total) * 100;
                syncProgressBar.style.width = `${percent}%`;
            }

            if (data.message) {
                syncStatusMessage.textContent = data.message;
            }

            // Update progress bar class based on status
            if (data.status === 'completed') {
                syncProgressBar.className = 'progress-bar progress-bar-success';
            } else if (data.status === 'error') {
                syncProgressBar.className = 'progress-bar progress-bar-danger';
            } else {
                syncProgressBar.className = 'progress-bar progress-bar-primary';
            }
        }
    });
</script>
{% endblock %}

{% block canvas_css %}
<style>
    /* Card styling */
    .group-card {
        height: 100%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #dee2e6;
    }

    .group-card .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
    }

    .group-card .card-body {
        max-height: 250px;
        overflow-y: auto;
        padding: 1rem;
    }

    /* Unassigned students styling */
    .unassigned-students-card {
        height: 100%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 1px solid #ffeeba;
    }

    .unassigned-students-card .card-body {
        max-height: 250px;
        overflow-y: auto;
        padding: 1rem;
    }

    .unassigned-students-card .card-header {
        background-color: #fff3cd;
        border-bottom: 1px solid #ffeeba;
        color: #856404;
        font-weight: 600;
    }

    /* Drag and drop styling */
    .student-item {
        cursor: grab;
        transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        border-radius: 4px;
        padding: 8px 10px;
        margin-bottom: 8px;
        background-color: #f8f9fa;
        border-left: 3px solid #5e72e4;
        user-select: none;
    }

    .student-item:hover {
        background-color: #e9ecef;
    }

    .student-item.sortable-chosen {
        background-color: #cce5ff;
        transform: scale(0.98);
        opacity: 0.8;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .student-item.sortable-ghost {
        opacity: 0.4;
        background-color: #e9ecef;
    }

    .student-item.sortable-drag {
        opacity: 0.8;
    }

    .members-list, .unassigned-list {
        min-height: 50px;
        padding: 8px;
        background-color: rgba(0,0,0,0.02);
        border-radius: 4px;
    }

    .members-list.sortable-drag, .unassigned-list.sortable-drag {
        background-color: rgba(94, 114, 228, 0.05);
    }

    .members-list-container, .unassigned-list-container {
        min-height: 150px;
    }

    .student-info {
        display: flex;
        flex-direction: column;
        flex: 1;
    }

    .student-email {
        font-size: 0.8em;
        color: #6c757d;
    }

    .sortable-fallback {
        opacity: 0.8;
        transform: rotate(3deg);
    }

    /* Drop zone indicators */
    .group-drop-zone, .unassigned-drop-zone {
        display: none;
        border: 2px dashed #5e72e4;
        border-radius: 4px;
        margin: 8px 0;
        padding: 10px;
        background-color: rgba(94, 114, 228, 0.05);
        text-align: center;
        color: #5e72e4;
    }

    /* Group with no members placeholder */
    .empty-group-placeholder {
        display: block;
        padding: 10px;
        text-align: center;
        color: #6c757d;
        background-color: rgba(0,0,0,0.02);
        border-radius: 4px;
        margin-top: 8px;
    }

    /* Button styling */
    .btn-outline-secondary {
        border-color: #6c757d;
        color: #6c757d;
    }

    .btn-outline-secondary:disabled {
        color: #6c757d;
        background-color: transparent;
        border-color: #6c757d;
        opacity: 0.65;
    }

    /* Progress container */
    .progress-container {
        margin-bottom: 20px;
    }

    .progress-message {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .progress {
        height: 0.75rem;
        background-color: #e9ecef;
    }

    .progress-bar {
        background-color: #007bff;
    }

    /* Member lists */
    .members-list .list-group-item,
    .unassigned-list .list-group-item {
        border-left: none;
        border-right: none;
        padding: 0.5rem 0.75rem;
    }

    .members-list .list-group-item:first-child,
    .unassigned-list .list-group-item:first-child {
        border-top: none;
    }

    .member-name {
        font-weight: 500;
        color: #212529;
    }

    /* Tab styling */
    .nav-tabs {
        border-bottom: 1px solid #dee2e6;
    }

    .nav-tabs .nav-link {
        color: #495057;
        border: 1px solid transparent;
    }

    .nav-tabs .nav-link.active {
        color: #007bff;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
        font-weight: 600;
    }

    .nav-tabs .nav-link:hover {
        border-color: #e9ecef #e9ecef #dee2e6;
    }

    /* Category details */
    .category-info {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.25rem;
        border: 1px solid #e9ecef;
    }

    .category-details {
        margin-top: 0.5rem;
    }

    .badge {
        padding: 0.4em 0.6em;
    }

    .initially-hidden {
        display: none;
    }

    /* Group description */
    .group-description {
        margin-bottom: 0.75rem;
        color: #495057;
    }

    /* Space between category action buttons */
    .category-actions .btn {
        margin-left: 0.25rem;
    }

    .group-actions .btn {
        margin-left: 0.25rem;
    }

    /* Save changes banner */
    .save-changes-banner {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: #fff3cd;
        padding: 10px;
        margin-top: 20px;
        border-top: 1px solid #ffeeba;
        display: none;
        align-items: center;
        justify-content: space-between;
        z-index: 100;
    }

    .save-changes-banner.visible {
        display: flex;
    }
</style>
{% endblock %}
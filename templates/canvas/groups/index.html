{% extends 'canvas/base.html' %}
{% load static %}
{% load user_timezone %}

{% block title %}Groups: {{ course.name }} | GradeBench Canvas{% endblock %}
{% block page_title %}{{ course.course_code }}: {{ course.name }} - Group Management{% endblock %}
{% block nav_canvas_dashboard %}active{% endblock %}

{% block extra_head %}
<!-- Add course ID for JavaScript access -->
<meta name="course-id" content="{{ course.canvas_id }}">
<style>
/* Override Paper Dashboard's progress bar styles for groups sync */
#syncProgress .progress {
    background-color: #e9ecef !important; /* Light gray background */
    height: 20px !important; /* Make it taller */
    border: 1px solid #dee2e6; /* Add border for visibility */
}

#syncProgress .progress-bar-primary {
    background-color: #0d6efd !important; /* Bootstrap 5 primary blue */
}

#syncProgress .progress-bar-success {
    background-color: #198754 !important; /* Bootstrap 5 success green */
}

#syncProgress .progress-bar-danger {
    background-color: #dc3545 !important; /* Bootstrap 5 danger red */
}

/* Animation for striped progress bar */
#syncProgress .progress-bar-striped {
    background-image: linear-gradient(45deg, 
        rgba(255,255,255,.15) 25%, 
        transparent 25%, 
        transparent 50%, 
        rgba(255,255,255,.15) 50%, 
        rgba(255,255,255,.15) 75%, 
        transparent 75%, 
        transparent) !important;
    background-size: 1rem 1rem !important;
}

#syncProgress .progress-bar.active {
    animation: progress-bar-stripes 1s linear infinite;
}

@keyframes progress-bar-stripes {
    from { background-position: 1rem 0; }
    to { background-position: 0 0; }
}
</style>
{% endblock %}

{% block canvas_content %}
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="card-title mb-0">Group Management</h4>
                    <p class="card-category">Manage Canvas groups and student memberships</p>
                </div>
                <div>
                    <a href="{% url 'canvas_course_detail' course_id=course.canvas_id %}" class="btn btn-sm btn-outline-primary btn-round">
                        <i class="fa fa-arrow-left"></i> Back to Course
                    </a>
                    <a href="{% url 'canvas_create_group_set' course_id=course.canvas_id %}" class="btn btn-sm btn-success btn-round">
                        <i class="fa fa-plus"></i> New Group Set
                    </a>
                    <button id="syncGroupsBtn" class="btn btn-sm btn-primary btn-round">
                        <i class="fa fa-refresh"></i> Sync Groups
                    </button>
                    <a href="{% url 'canvas_push_group_memberships' course_id=course.canvas_id %}" class="btn btn-sm btn-info btn-round">
                        <i class="fa fa-upload"></i> Push Memberships
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div id="syncProgress" class="progress-container mb-3" style="display: none;">
                    <span id="syncStatusMessage" class="progress-message">Syncing groups...</span>
                    <div class="progress">
                        <div id="syncProgressBar" class="progress-bar progress-bar-primary" role="progressbar" style="width: 0%;">
                        </div>
                    </div>
                </div>

                {% if not category_data %}
                <div class="alert alert-info" role="alert">
                    <h4 class="alert-heading">No Group Sets Found</h4>
                    <p><i class="fa fa-info-circle"></i> No group sets found for this course.</p>
                    <p>Group sets need to be synchronized from Canvas first. Click the "Sync Groups" button above to fetch group sets, groups, and memberships from Canvas.</p>
                </div>
                {% else %}
                <div class="group-management-container">
                    <!-- Group Set Tabs -->
                    <ul class="nav nav-tabs" id="groupSetTabs" role="tablist">
                        {% for cat_data in category_data %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link {% if forloop.first %}active{% endif %}"
                                    id="groupset-{{ cat_data.category.id }}-tab"
                                    data-bs-toggle="tab"
                                    data-bs-target="#groupset-{{ cat_data.category.id }}-content"
                                    data-category-id="{{ cat_data.category.id }}"
                                    type="button"
                                    role="tab"
                                    aria-controls="groupset-{{ cat_data.category.id }}-content"
                                    aria-selected="{% if forloop.first %}true{% else %}false{% endif %}">
                                {{ cat_data.category.name }}
                                <span class="badge bg-primary">{{ cat_data.groups_count }}</span>
                            </button>
                        </li>
                        {% endfor %}
                    </ul>

                    <!-- Tab Content -->
                    <div class="tab-content mt-3" id="groupSetTabContent">
                        {% for cat_data in category_data %}
                        <div class="tab-pane fade {% if forloop.first %}show active{% endif %}"
                             id="groupset-{{ cat_data.category.id }}-content"
                             role="tabpanel"
                             aria-labelledby="groupset-{{ cat_data.category.id }}-tab">

                            <!-- Category Info -->
                            <div class="category-info mb-3">
                                <div class="d-flex justify-content-between">
                                    <h5>{{ cat_data.category.name }}</h5>
                                    <div class="category-actions">
                                        <a href="{% url 'canvas_edit_group_set' course_id=course.canvas_id group_set_id=cat_data.category.id %}" class="btn btn-sm btn-primary btn-round">
                                            <i class="fa fa-pencil"></i> Edit
                                        </a>
                                        <button class="btn btn-sm btn-danger btn-round delete-group-set-btn"
                                                data-category-id="{{ cat_data.category.id }}"
                                                data-category-name="{{ cat_data.category.name }}">
                                            <i class="fa fa-trash"></i> Delete
                                        </button>
                                        <a href="{% url 'canvas_create_group_alias' course_id=course.canvas_id group_set_id=cat_data.category.id %}" class="btn btn-sm btn-success btn-round">
                                            <i class="fa fa-plus"></i> Add Group
                                        </a>
                                    </div>
                                </div>
                                <div class="category-details">
                                    <span class="badge bg-info me-2">
                                        {{ cat_data.groups_count }} Group{% if cat_data.groups_count != 1 %}s{% endif %}
                                    </span>
                                    <span class="badge bg-info">
                                        {{ cat_data.members_count }} Member{% if cat_data.members_count != 1 %}s{% endif %}
                                    </span>

                                    {% if cat_data.category.self_signup %}
                                    <span class="badge bg-success ms-2">Self Sign-up Enabled</span>
                                    {% endif %}

                                    {% if cat_data.category.group_limit %}
                                    <span class="badge bg-warning ms-2">
                                        Limit: {{ cat_data.category.group_limit }} per group
                                    </span>
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Groups Loading Placeholder -->
                            <div id="loading-{{ cat_data.category.id }}" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading groups...</span>
                                </div>
                                <p class="mt-2">Loading groups and students...</p>
                            </div>

                            <!-- Groups Container (filled by JavaScript) -->
                            <div id="groups-container-{{ cat_data.category.id }}" class="groups-container" style="display: none;">
                                <!-- Will be filled by JavaScript -->
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="card-footer">
                <div class="stats">
                    <i class="fa fa-users"></i> {{ total_students }} total student{% if total_students != 1 %}s{% endif %}
                    {% if unassigned_students > 0 %}
                    <span class="ms-3 text-warning">
                        <i class="fa fa-exclamation-triangle"></i> {{ unassigned_students }} unassigned student{% if unassigned_students != 1 %}s{% endif %}
                    </span>
                    {% endif %}

                    {% if last_sync %}
                    <span class="ms-3">
                        <i class="fa fa-clock-o"></i> Last synced: {{ last_sync|user_timezone:user|date:"M d, Y H:i" }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Group template (for JavaScript rendering) -->
<template id="group-template">
    <div class="card mb-3 group-card">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
            <h6 class="mb-0 group-name"></h6>
            <div class="group-actions">
                <a href="#" class="btn btn-sm btn-primary btn-round edit-group-btn">
                    <i class="fa fa-pencil"></i> Edit
                </a>
                <button class="btn btn-sm btn-danger btn-round delete-group-btn">
                    <i class="fa fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="card-body">
            <p class="group-description mb-2"></p>
            <div class="group-members">
                <h6 class="mb-2">Members:</h6>
                <ul class="list-group list-group-flush members-list">
                    <!-- Members will be added here -->
                </ul>
            </div>
        </div>
    </div>
</template>

<!-- Member template (for JavaScript rendering) -->
<template id="member-template">
    <li class="list-group-item student-item d-flex justify-content-between align-items-center">
        <div class="student-info">
            <span class="member-name"></span>
            <small class="student-email"></small>
        </div>
        <span class="drag-handle" title="Drag to move student">
            <i class="fa fa-grip-lines"></i>
        </span>
    </li>
</template>

<!-- Unassigned students template -->
<template id="unassigned-students-template">
    <div class="card mb-3 unassigned-students-card">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
            <h6 class="mb-0">Unassigned Students</h6>
            <div class="unassigned-actions">
                <button class="btn btn-sm btn-warning btn-round random-assign-btn">
                    <i class="fa fa-random"></i> Random Assign
                </button>
            </div>
        </div>
        <div class="card-body">
            <ul class="list-group list-group-flush unassigned-list">
                <!-- Unassigned students will be added here -->
            </ul>
        </div>
    </div>
</template>

<!-- Save changes banner -->
<div id="saveChangesBanner" class="save-changes-banner">
    <div class="banner-message">
        <strong>Unsaved changes!</strong> You have made changes to student assignments that haven't been saved.
    </div>
    <div class="banner-actions">
        <button id="discardChangesBtn" class="btn btn-sm btn-secondary btn-round me-2">Discard Changes</button>
        <button id="saveChangesBtn" class="btn btn-sm btn-warning btn-round">Save Changes</button>
    </div>
</div>

<!-- Confirmation Modal for Deleting -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmDeleteModalLabel">
          <i class="fa fa-exclamation-triangle me-2"></i>Confirm Delete
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmDeleteModalBody">
        <p class="mb-0">Are you sure you want to delete this item?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-round" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger btn-round" id="confirmDeleteButton">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- CSRF token for AJAX requests -->
{% csrf_token %}
{% endblock %}

{% block canvas_js %}
<!-- Directly include SortableJS first -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- Use final version with drag and drop functionality -->
<script src="{% static 'js/canvas-group-sortable-fixed.js' %}"></script>
<!-- Include delete group modal with spinner -->
<script src="{% static 'js/delete-group-modal.js' %}"></script>
<!-- Include group set management functionality -->
<script src="{% static 'js/canvas-group-set-management.js' %}"></script>
{% endblock %}

{% block canvas_css %}
{% load static %}
<link href="{% static 'css/groups.css' %}" rel="stylesheet" />

{% endblock %}
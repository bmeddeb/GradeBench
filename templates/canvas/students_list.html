{% extends 'canvas/base.html' %}
{% load static %}

{% block title %}Canvas Students | GradeBench{% endblock %}
{% block page_title %}Canvas Students{% endblock %}
{% block nav_canvas_students %}active{% endblock %}

{% block extra_css %}
{{ block.super }}
<!-- DataTables CSS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css"/>
<style>
    .bootstrap-tagsinput {
        width: 100%;
        min-height: 40px;
    }
    .bootstrap-tagsinput .badge {
        margin: 2px;
        padding: 5px 8px;
    }
    .badge[data-group-id], .group-badge, .badge[data-course-id], .course-badge {
        cursor: pointer;
        transition: all 0.3s;
        margin: 2px 3px;
        display: inline-block;
    }
    .badge[data-group-id]:hover, .group-badge:hover {
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transform: translateY(-1px);
        background-color: #28a745 !important; /* Slightly darker green */
    }
    .badge[data-course-id]:hover, .course-badge:hover {
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transform: translateY(-1px);
        background-color: #0d6efd !important; /* Slightly darker blue */
    }
    table.dataTable thead .sorting:after,
    table.dataTable thead .sorting_asc:after,
    table.dataTable thead .sorting_desc:after {
        top: 8px;
        right: 4px;
    }
    /* Improve table appearance */
    #students-table {
        width: 100% !important;
    }
    #students-table th {
        font-weight: bold;
    }
    /* Make group badges more visible */
    .tagsinput {
        display: flex;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block canvas_content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="card-title">Canvas Students</h4>
                    <p class="card-category">All students enrolled across Canvas courses</p>
                </div>
                {% if students %}
                <div>
                    <a href="{% url 'canvas_courses_list' %}" class="btn btn-primary btn-sm">
                        <i class="fa fa-plus"></i> Add More Courses
                    </a>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    {% if students %}
                    <table id="students-table" class="table table-hover table-striped">
                        <thead class="text-primary">
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Courses</th>
                                <th>Groups</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr>
                                <td>{{ student.name }}</td>
                                <td>{{ student.email|default:"Not available" }}</td>
                                <td data-sort="{{ student.courses.0.course.course_code|default:'' }}">
                                    <div class="tagsinput">
                                        {% for course_info in student.courses %}
                                        <a href="{% url 'canvas_course_detail' course_id=course_info.course.canvas_id %}" class="badge bg-info course-badge" title="Click to view course">
                                            <i class="fa fa-bookmark fa-xs me-1"></i>
                                            {{ course_info.course.course_code }}
                                        </a>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td>
                                    <div class="tagsinput">
                                        {% for group in student.groups %}
                                        <a href="{% url 'canvas_course_groups' course_id=group.course_id %}#category-{{ group.category_id }}" class="badge badge-success group-badge" title="Click to view group">
                                            <i class="fa fa-users fa-xs me-1"></i>
                                            {{ group.name }} ({{ group.category_name }})
                                        </a>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td>
                                    {% for course_info in student.courses %}
                                    <a href="{% url 'canvas_student_detail' course_id=course_info.course.canvas_id user_id=student.user_id %}" class="btn btn-info btn-xs mb-1">
                                        <i class="fa fa-eye"></i> View in {{ course_info.course.course_code }}
                                    </a>
                                    {% if not forloop.last %}<br>{% endif %}
                                    {% endfor %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="text-center py-5">
                        <h3>No students found</h3>
                        <p>No students have been enrolled in any Canvas courses yet.</p>
                        <p>
                            <button id="openSyncModal" class="btn btn-primary btn-round mt-3" type="button" data-bs-toggle="modal" data-bs-target="#syncCoursesModal">
                                <i class="fa fa-plus"></i> Add Courses from Canvas
                            </button>
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for selecting Canvas courses to sync -->
<div class="modal fade" id="syncCoursesModal" tabindex="-1" aria-labelledby="syncCoursesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="syncCoursesModalLabel">
          <i class="fa fa-refresh me-2"></i>Select Canvas Courses to Sync
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="coursesLoading">Loading courses...</div>
        <div id="coursesList" class="initially-hidden">
          <button class="btn btn-link btn-sm" onclick="selectAllCourses(true)">Select All</button>
          <button class="btn btn-link btn-sm" onclick="selectAllCourses(false)">Deselect All</button>
          <ul id="coursesCheckboxList" class="courses-checkbox-list list-unstyled mt-2"></ul>
        </div>
        <div id="coursesError" class="alert alert-danger initially-hidden" role="alert">
          <h5 class="alert-heading"><i class="fa fa-exclamation-triangle me-2"></i>Error</h5>
          <p class="mb-0"></p>
        </div>
      </div>
      <div class="modal-footer">
        <div id="syncProgressIndicator" class="initially-hidden me-auto">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Syncing courses...</span>
          </div>
          <span class="ms-2">Syncing courses, please wait...</span>
        </div>
        <button id="syncSelectedBtn" class="btn btn-primary btn-round" onclick="syncSelectedCourses()">Sync Selected</button>
        <button id="syncAllBtn" class="btn btn-secondary btn-round" onclick="syncAllCourses()">Sync All</button>
        <button id="closeModalBtn" class="btn btn-outline-secondary btn-round" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- DataTables JS -->
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
<script>
    // Fix for paper-dashboard.min.js jQuery tagsinput error
    $.fn.tagsinput = $.fn.tagsinput || function() { return this; };
    
    $(document).ready(function() {
        // Initialize DataTable for sorting
        $('#students-table').DataTable({
            "order": [[0, "asc"]],  // Default sort by name
            "paging": false,
            "info": false,
            "searching": true,
            "columnDefs": [
                { "orderable": false, "targets": 4 }  // Disable sorting on actions column
            ]
        });
    });
</script>
<script src="{% static 'js/canvas-sync-progress.js' %}"></script>
<script src="{% static 'js/Sync-modal.js' %}"></script>
<script src="{% static 'js/canvas-sync-init.js' %}"></script>
{% endblock %}